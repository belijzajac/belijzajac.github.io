<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.91.2">
<meta name=description content="Some description">
<link rel=apple-touch-icon sizes=180x180 href=https://belijzajac.dev/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=https://belijzajac.dev/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=https://belijzajac.dev/favicon-16x16.png>
<link rel=manifest href=https://belijzajac.dev/site.webmanifest>
<link rel=mask-icon href=https://belijzajac.dev/safari-pinned-tab.svg color=#5bbad5>
<meta name=msapplication-TileColor content="#da532c">
<meta name=theme-color content="#ffffff">
<link rel=stylesheet href=https://belijzajac.dev/css/bootstrap.min.css>
<title>Outperforming Rayon with OpenMP | belijzajac.dev</title>
<style>body{min-width:300px}.custom-navbar{margin-bottom:1em;height:60px}.custom-navbar a{display:inline-block;padding:18px 0;margin-right:1em;font-weight:700}.custom-navbar a:hover,.custom-navbar a:focus{text-decoration:none}@media print{.custom-navbar{display:none}}article{padding-bottom:1em}img{max-width:100%}body{background-color:#fff}body{color:#212529}a{color:#007bff}a:hover,a:focus{color:#0056b3}.custom-navbar{background-color:#212529}.custom-navbar a{color:rgba(255,255,255,.75)}.custom-navbar a:hover,.custom-navbar a:focus{color:#fff}.container{max-width:800px}pre{display:block;padding:9.5px;word-break:break-all;word-wrap:break-word;background-color:#f5f5f5}pre code{padding:0;font-size:inherit;color:inherit;white-space:pre-wrap;background-color:transparent;border:none;border-radius:0}code{padding:2px 4px;color:inherit;background-color:#f5f5f5;border:1px solid #ccc;border-radius:4px;font-size:.9em}blockquote,.blockquote{padding:10px 20px;margin:0 0 20px;font-size:1em;border-left:5px solid #6c757d}.footer{text-align:center;color:#b3b3b3}.footer a{color:inherit}.separator{border:0;border-top:3px dashed #ccc}.email{background-color:#101010;color:#fff}</style>
</head>
<body>
<nav class=custom-navbar>
<div class=container>
<span class=navbar-text>
<p style=color:#fff;font-size:20px><b>belijzajac.dev</b></p>
</span>
<span style=padding-left:20px>
<a href=/>Posts</a>
<a href=/index.xml>RSS</a>
</div>
</nav>
<div class=container>
<article>
<h1>Outperforming Rayon with OpenMP</h1>
<p>
<small class=text-secondary>
Nov 16, 2021, updated Dec 25, 2021
</small>
<small><code><a href=https://belijzajac.dev/tags/rust>rust</a></code></small>
<small><code><a href=https://belijzajac.dev/tags/c>c</a></code></small>
<small><code><a href=https://belijzajac.dev/tags/perf>perf</a></code></small>
<small><code><a href=https://belijzajac.dev/tags/openmp>openmp</a></code></small>
<small><code><a href=https://belijzajac.dev/tags/blockchain>blockchain</a></code></small>
<small><code><a href=https://belijzajac.dev/tags/kzg-proofs>kzg-proofs</a></code></small>
<small><code><a href=https://belijzajac.dev/tags/bls12-381>bls12-381</a></code></small>
</p>
<h2 id=whats-all-the-fuss-about>What’s all the fuss about?</h2>
<p>For my Blockchain Technologies course we had two teams competing against each other to produce the fastest Rust library for kzg commitments. Both of us were using the same backend, that is <a href=https://github.com/supranational/blst>blst</a> (implemented in assembly but had direct bindings for Rust and C). The first team, <a href=https://github.com/sifraitech/kzg/tree/main/blst-from-scratch>blst-from-scratch</a>, were using the said Rust bindings to produce an interface as closer to <a href=https://github.com/benjaminion/c-kzg>c-kzg</a>, whereas the second <a href=https://github.com/sifraitech/kzg/tree/main/ckzg>ckzg</a> team, which I was part of, was responsible for porting the latter over to Rust.</p>
<h2 id=choosing-the-right-tool-for-the-job>Choosing the right tool for the job</h2>
<p>While it&rsquo;s kind of obvious for Rust programmers to pick <code>Rayon</code> because there aren&rsquo;t any other viable options out of the box, I had to make a decision on which direction to go by:</p>
<ul>
<li>Use <code>pthread</code>s manually</li>
<li>Some random guy&rsquo;s threadpool library with the most stars from GitHub</li>
<li><code>OpenMP</code></li>
</ul>
<p>I picked <code>OpenMP</code> because while experimenting, I found it to produce the best results, and it was no-brainer to use except for coming up on how to seemingly integrate it with Rust that would work on multiple platforms.</p>
<h2 id=searching-for-bottlenecks>Searching for bottlenecks</h2>
<p>The general procedure for looking for what to parallelize is to use tools such as <code>Perf</code> that produces flamegraphs, which are a really nice visual way to represent the CPU time of a program. Below is the flamegraph that was generated by running <code>fft_g1</code> benchmark:</p>
<p><img src=/post-images/flame-graphu.svg alt=flamegraph-of-fft-g1></p>
<p>which, in fact, had a huge impact on performance with the majority of calls tracing down to assembly code; a similar kzg implementation library (<a href=https://github.com/protolambda/go-kzg/blob/master/BENCH.md>go-kzg</a>) that was taken as a reference a few times while producing unit tests and benchmarks showed that their <code>fft_g1</code> benchmark took the longest to execute among others.</p>
<p>So, we have 7 groups of benchmarks</p>
<ul>
<li>das</li>
<li>fft</li>
<li>fk20</li>
<li>kzg</li>
<li>poly</li>
<li>recover</li>
<li>zero_poly</li>
</ul>
<p>of which let&rsquo;s pick <code>fft_g1</code> from the <code>fft</code> group to parallelize out!</p>
<h2 id=parallelizing-fft_g1>Parallelizing fft_g1</h2>
<p>The blst-from-scratch team implemented it as follows:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#8be9fd;font-style:italic>let</span> (lo, hi) <span style=color:#ff79c6>=</span> ret.split_at_mut(half);
rayon::join(
  <span style=color:#ff79c6>||</span> fft_g1_fast(lo, data, stride <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>2</span>, roots, roots_stride <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>2</span>),
  <span style=color:#ff79c6>||</span> fft_g1_fast(hi, <span style=color:#ff79c6>&amp;</span>data[stride<span style=color:#ff79c6>..</span>], stride <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>2</span>, roots, roots_stride <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>2</span>)
);

<span style=color:#ff79c6>for</span> i <span style=color:#ff79c6>in</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>..</span>half {
  <span style=color:#8be9fd;font-style:italic>let</span> y_times_root <span style=color:#ff79c6>=</span> ret[i <span style=color:#ff79c6>+</span> half].mul(<span style=color:#ff79c6>&amp;</span>roots[i <span style=color:#ff79c6>*</span> roots_stride]);
  ret[i <span style=color:#ff79c6>+</span> half] <span style=color:#ff79c6>=</span> ret[i].sub(<span style=color:#ff79c6>&amp;</span>y_times_root);
  ret[i] <span style=color:#ff79c6>=</span> ret[i].add_or_dbl(<span style=color:#ff79c6>&amp;</span>y_times_root);
}
</code></pre></div><p>As a side note, <code>rayon::join</code> spawns two threads, one executing each of the two closures.</p>
<p>The C equivalent, on the other hand, was as follows:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#ff79c6>#pragma omp parallel sections
</span><span style=color:#ff79c6></span>{
  <span style=color:#ff79c6>#pragma omp section
</span><span style=color:#ff79c6></span>  {
    fft_g1_fast(out, in, stride <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>2</span>, roots, roots_stride <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>2</span>, half);
  }
  <span style=color:#ff79c6>#pragma omp section
</span><span style=color:#ff79c6></span>  {
    fft_g1_fast(out <span style=color:#ff79c6>+</span> half, in <span style=color:#ff79c6>+</span> stride, stride <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>2</span>, roots, roots_stride <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>2</span>, half);
  }
}
<span style=color:#ff79c6>#pragma omp parallel
</span><span style=color:#ff79c6>#pragma omp for
</span><span style=color:#ff79c6></span><span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>uint64_t</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> half; i<span style=color:#ff79c6>++</span>) {
  g1_t y_times_root;
  g1_mul(<span style=color:#ff79c6>&amp;</span>y_times_root, <span style=color:#ff79c6>&amp;</span>out[i <span style=color:#ff79c6>+</span> half], <span style=color:#ff79c6>&amp;</span>roots[i <span style=color:#ff79c6>*</span> roots_stride]);
  g1_sub(<span style=color:#ff79c6>&amp;</span>out[i <span style=color:#ff79c6>+</span> half], <span style=color:#ff79c6>&amp;</span>out[i], <span style=color:#ff79c6>&amp;</span>y_times_root);
  g1_add_or_dbl(<span style=color:#ff79c6>&amp;</span>out[i], <span style=color:#ff79c6>&amp;</span>out[i], <span style=color:#ff79c6>&amp;</span>y_times_root);
}
</code></pre></div><h2 id=results-comparison>Results comparison</h2>
<h3 id=local-c-kzg-benchmark>Local c-kzg benchmark</h3>
<p>Running on my personal computer with 4 threads @ 3.50GHz, I was able to obtain the following results:</p>
<p>Original:</p>
<pre tabindex=0><code>./fft_g1_bench
*** Benchmarking FFT_g1, 1 second per test.
fft_g1/scale_4 1729769 ns/op
fft_g1/scale_5 4935085 ns/op
fft_g1/scale_6 12897731 ns/op
fft_g1/scale_7 32022026 ns/op
fft_g1/scale_8 76552852 ns/op
fft_g1/scale_9 184970057 ns/op
fft_g1/scale_10 418273808 ns/op
fft_g1/scale_11 919499032 ns/op
fft_g1/scale_12 2025633037 ns/op
fft_g1/scale_13 4479830518 ns/op
fft_g1/scale_14 9754557496 ns/op
fft_g1/scale_15 21125613058 ns/op
</code></pre><p>Parallelized:</p>
<pre tabindex=0><code>OMP_NUM_THREADS=4 ./fft_g1_bench
*** Benchmarking FFT_g1, 1 second per test.
fft_g1/scale_4 839454 ns/op
fft_g1/scale_5 2378457 ns/op
fft_g1/scale_6 6404191 ns/op
fft_g1/scale_7 16325966 ns/op
fft_g1/scale_8 38141754 ns/op
fft_g1/scale_9 90948810 ns/op
fft_g1/scale_10 204757690 ns/op
fft_g1/scale_11 457509973 ns/op
fft_g1/scale_12 1006089135 ns/op
fft_g1/scale_13 2240095284 ns/op
fft_g1/scale_14 4879448286 ns/op
fft_g1/scale_15 10650876381 ns/op
</code></pre><p>that&rsquo;s <strong>twice as fast!</strong></p>
<h3 id=github-actions-benchmark>GitHub Actions benchmark</h3>
<p>The <code>fft_g1</code> benchmark was limited to scale 7 because the overall run time for the job usually exceeded the 6 hours limit, that used to automatically cancel any other running jobs.</p>
<h4 id=blst-from-scratch>blst-from-scratch</h4>
<p><img src=/post-images/from-scratch-github-actions.png alt=from-scratch-github-actions></p>
<pre tabindex=0><code>Benchmarking bench_fft_g1 scale: '7'
Benchmarking bench_fft_g1 scale: '7': Warming up for 3.0000 s
Benchmarking bench_fft_g1 scale: '7': Collecting 100 samples in estimated 6.3282 s (300 iterations)
Benchmarking bench_fft_g1 scale: '7': Analyzing
bench_fft_g1 scale: '7' time:   [20.432 ms 20.634 ms 20.843 ms]
                        change: [-39.822% -38.926% -38.001%] (p = 0.00 &lt; 0.05)
                        Performance has improved.
</code></pre><h4 id=ckzg>ckzg</h4>
<p><img src=/post-images/ckzg-github-actions.png alt=ckzg-github-actions></p>
<pre tabindex=0><code>Benchmarking bench_fft_g1 scale: '7'
Benchmarking bench_fft_g1 scale: '7': Warming up for 3.0000 s
Benchmarking bench_fft_g1 scale: '7': Collecting 100 samples in estimated 5.0701 s (300 iterations)
Benchmarking bench_fft_g1 scale: '7': Analyzing
bench_fft_g1 scale: '7' time:   [16.854 ms 17.107 ms 17.439 ms]
                        change: [-48.216% -47.318% -46.306%] (p = 0.00 &lt; 0.05)
                        Performance has improved.
</code></pre><p>All in all, we can clearly see who&rsquo;s the winner here :)</p>
<div class=separator></div>
<br>
<div class=media>
<div class=media-left>
<img class=media-object src=https://belijzajac.dev/author.png>
</div>
<div class=media-body>
<h4 class=media-heading>The author behind this post</h4>
I'm a software developer interested in systems programming languages who loves tinkering with Linux.
I'm available for collaborations on projects, and you can reach out to me at
<div class=email>
$ echo dGF1dHZ5ZGFzNzQ5QGdtYWlsLmNvbQ== | base64 -d
</div>
</div>
</div>
</article>
<footer class=footer>
<span>
Copyright © 2021
<a href=https://github.com/belijzajac target=_blank rel=noopener>belijzajac</a>
</span>
</footer>
</div>
</body>
</html>