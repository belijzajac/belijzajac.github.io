<!--
                                                                                   .                                                                                                                    
                             @%#####@#                                        @@########@                                                                                                               
                          &###########%@                                    @%%@###########(                                                                                                            
                       @##############%%%@,                               @%%%%@#############,                                                                                                          
                    @########&########%%%%%%@                            %%%%%%%##############@                                                                                                         
                  @##################@%%%%%%%%@                        %%%%%%%%%@###############/                                                                                                       
                @###################@%%%%%%%%%%%@                     %%%%%%%%%%%################@                                                                                                      
              @####################@%%%%%%%%%%%%%%*                 @%%%%%%%%%%%%@################@                                                                                                     
            (%###################@ &%%%%%%%%%%%%%%%@               @%%%%%%%%%%%%%%@################/                                                                                                    
           @###################@# .  @%%%%%%%%%%%%%%%@            @%%%%%%%%%%%%%%%  ################                                                                                                    
         @###################&@        @%%%%%%%%%%%%%%%/         @%%%%%%%%%%%%%&     @##############@                                @*                                                                 
        @##################@@             @%%%%%%%%%%%%%@       @%%%%%%%%%%%%@        @#############@                              @//////@,                                                            
      @##################@                   @%%%%%%%%%%%@     @%%%%%%%%%@              &###########@                           *@    @     #////#                                  @@@@                
    *%###############%@                           @@%%%%@@/  %@%%%%%%@*                  @##########@                         ///////////*     ////                              @////////*             
   @#############&@                             @@.  *     ....,**.   @,                   @########@                      .(////////////((..@@*                                @/////////@             
  @##########@@                             @.    @&    ,..   ,   ......   (                ########@                 @////////////////((@                                     &      ////@             
.%#######@&                              @      .      &             .. ..    @               @#####@                @////////////////(@                                      *       *///@             
#####@#                               /%      .                      #.   .     @.             @####@                @//////////.,///(                                       @ *      @/#(@             
##@                                 @       /   @               #     .          @               @##@                 @            *(/                                      @         /((((             
                                   /           @                ,,                  @                                  @            @                                                 /(@((@            
                                 @           *,@.           * @@(@,@    @           .@                                  @       *//(@                                      @          (@(((@            
                                %           @,,,           .  .,,  ,@   %         .   @                                  */////////(@                                     @///////   ((((..%            
                                      .   .@,,,,, .    .   .  %,     @..,@.      ..  &                                   @/////////(@                                    @/////////(((.....,(           
                               @     .   .(,,,   ,.@   .  .. %,       #./,.........@ . @                                 .          @                                   @      ////....../(((@          
                                    ......,,,  ./  @@  .. .& ,  .///.  .%,#......... .@                                   @         %                                  @         /@...,(((#             
                              @ .  ......@(@,//////*,@....(,( ,,&/////@@@@@...........@ @                                 @    /////(.                               #           &/((((@                
                              @ * .......@@, @/////@ . @../     #//////,@@@..../.../@.@.@                                  /////////(@                              @//////////                         
                              @% .......@,@  @  ...@     .,     @  .. & ,@&........@*.@./                                  @/////////(*                           */////////////,                       
                              @  .....@.#,     &#@               #/.#@    .....   @@*....                                  @/        .#                          @      ///////@                        
                              @  @..../...            &                  @..@....****@...@                                            .@                                     ///                        
                             .    @    / @                          @@  , **/,..@**/@(/@@@&                                     .//////(                      @               @                         
                                  @ @   .@#                           @@   @  @    #/@       @                              @//////////(@                    @/////////      .                          
                                     %,     @@                    ,     ,  @    @ @/@         .,                            @///////////(,                 @///////////////  *                          
                                  @             ,#       .     ,             @   *#/          .@                            %            &                @        /////////@                           
                                  @   ,*         .,@         @                  @#,          ..@                                         .@             .              ////@                            
                                 @       @*        ..@&,&@@,,/              @..@@,          ...@                                      .//((            @                  @                             
                                 #       @         ..##%,,,,,,#         @##@@..@@@,         ..*&////&@@ @#///////#//////////@@///////////((@          /,//////           @,                             
                                       (          ,#####@,(,,,           @(#@...@          .,.,@///////////%@&///////////////*///@@@@/////*@          #//////////////   #                               
                                 (    @          @%*######,,,,,           #..(@.,         ...,,.@@////////////////#////%(////&((@(/@     (/////. #@( @*///////////////(*,                               
                                @    @          @,,###.#####*,,,            ...%,        ....,/.#.@#..   ####@////////@/////(////&//       &//////     /@.       ////((,                                
                              @/////@          @@,*..%.@###/&##@#           ..*&/////////(/%,,@..(* ...#   &#@    //////&(/////////(/        @//////     ///@      ./#                                  
                             @ (///           .@ @@.......@%%%...@           @@//////////////##@*** #....@   #@     (/////@@@(//////(%        (//////      ///    ..@                                   
                            @//@@@           ,.@  @...,@..@..%&%@@@           @/(////(//(/  (##@*** @%.@...@  @@      %////&///(##(///#        @/////      ////*...&                                    
                            @@  @           /..@   ,..*.,.&..@%%%%@..          @/(////(//////#@@*@/.....%  %,  @%     .%//////////@#(/@      ..@/////,     //(((..,                                     
                            @ %            @..*@    ..........%@@%%.@           /..........@###...... ..@@...@  @    ..(////@///////#@@........//////  ....(((((.,                                      
                             @            @@...@     ........@%@%%%/.@            ......   ..@,.........%,../(   %.....,////@/(/////@#,,,,,,,,@((((((....((((((.@                                       
                           @               #...@         @.@.@%&%%%&..@             @..    ......&*#@@@.@.*./. ..&..,,,@####////@////%,,,,,,,@(((((...(((((@%                                           
                          @              @ /..,%            @%%%%%%%...@            .@.   ..@*...#**..@##.& (*@,,@,,,,(####/////(####&,,,,,@(((((.#@.                                                   
                         @              @  %...%            @%%%&%%%....,            .@@ ..@*&%%*/,.@.@@*.@ .@,,,%,,,###%##//(#######@@@@@                                                              
                         (            .@   @...@            &%%@@%%%@...&            ...(....@ /**&.&*,.&..@,*/,*@##@#######@@@@@#                                                                      
                        /            .@    @.,.%           @%%%*@%%%% .//@           ......*.@@(*****/@.*&@&**@@@.                                                                                      
                     ...@         .*      #@.#        %@@#%%%%@ %%%%%@    *         ..@..@*@@@@@@@ .*@ /.*@*@,**/@                                                                                      
                       &      ...@......                         &%######   &,  ........@    ( /@..#@*%.@***@**%                                                                                        
                                                                               .@.......*         @***&*****@                                                                                           
                                                                                                                                                                                                        
-->
<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.112.5"><meta name=description content="belijzajac's personal blog, where he shows off some of his current, past, and future projects as well as shares personal experience of developing projects involving modern C++ and Linux!"><link rel=icon href=https://belijzajac.dev/shimakaze.gif><link rel=stylesheet href=https://belijzajac.dev/css/bootstrap.min.css><link rel=stylesheet href=https://belijzajac.dev/css/font-awesome.min.css><title>Proto-Danksharding: Speeding Up Blobs Verification | belijzajac.dev</title><style>.table-of-contents{position:sticky;top:2em;margin-right:-380px;width:320px;font-size:.9em;float:right;padding-top:15px;padding-left:15px;font-family:serif;background:#e0dedd;box-shadow:1px 1px 2px rgba(0,0,0,.125);word-wrap:break-word;box-sizing:border-box}.table-of-contents ul{list-style:none;line-height:2;padding-left:15px}.table-of-contents ul ul{margin-bottom:0}.table-of-contents ul li ul{line-height:1.66}.table-of-contents a{color:var(--text-light)}.table-of-contents a:hover{color:var(--text-darkish)}@media screen and (max-width:1500px){.table-of-contents{display:none}}.table-of-contents li.active>a{color:#454545;font-weight:850}.table-of-contents a{transition:all 100ms ease-in-out}mark{background:#ffe28e!important}body{min-width:300px}.navbar{margin-bottom:1em}article{padding-bottom:1em}img{max-width:100%}body{background:#ece9e6;background:-webkit-linear-gradient(to top,#FFFFFF,#ECE9E6);background:linear-gradient(to right,#FFFFFF,#ECE9E6)}body{color:#212529}a{color:#00254f}a:hover,a:focus{color:#000914}.container{max-width:900px}pre{display:block;padding:9.5px;word-break:break-all;word-wrap:break-word;background-color:#ead6d4}pre code{padding:0;font-size:inherit;color:inherit;white-space:pre-wrap;background-color:transparent;border:none;border-radius:0}code{padding:2px 4px;color:inherit;background-color:#ead6d4;border:1px solid #333;border-radius:4px;font-size:.9em}blockquote,.blockquote{padding:10px 20px;margin:0 0 20px;font-size:1em;border-left:5px solid #6c757d}.footer{text-align:center;color:#7d7d7d}.footer a{color:inherit}.separator{border:0;border-top:3px dashed #000}h1{font-size:230%}</style></head><body><nav class="navbar navbar-expand-md navbar-dark" style=background-color:#222121><div class=container-fluid><button class="navbar-toggler navbar-toggler-right border-0 p-0" type=button data-toggle=collapse data-target=#navbar20>
<span class=navbar-toggler-icon></span><p class="navbar-brand text-white mb-0">&nbsp;belijzajac.dev</p></button><div class="collapse navbar-collapse" id=navbar20><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=/>Posts</a></li></ul><p class="d-none d-md-block lead mb-0 text-white"><b>belijzajac.dev</b></p><ul class="navbar-nav ml-auto"><li class="nav-item mx-1"><a class=nav-link href=mailto:blog@belijzajac.dev><i class="fa fa-envelope-o fa-fw fa-lg"></i></a></li><li class="nav-item mx-1"><a class=nav-link href=https://github.com/belijzajac target=_blank rel=noopener><i class="fa fa-github fa-fw fa-lg"></i></a></li><li class="nav-item mx-1"><a class=nav-link href=https://twitter.com/belijzajac target=_blank rel=noopener><i class="fa fa-twitter fa-fw fa-lg"></i></a></li><li class="nav-item mx-1"><a class=nav-link href=/index.xml target=_blank rel=noopener><i class="fa fa-rss fa-fw fa-lg"></i></a></li></ul></div></div></nav><div class=container><article><h1>Proto-Danksharding: Speeding Up Blobs Verification</h1><p><small class=text-secondary>May 27, 2023, updated May 30, 2023</small>
<small><code><a href=https://belijzajac.dev/tags/rust>rust</a></code></small>
<small><code><a href=https://belijzajac.dev/tags/ethereum>ethereum</a></code></small>
<small><code><a href=https://belijzajac.dev/tags/eip-4844>eip-4844</a></code></small>
<small><code><a href=https://belijzajac.dev/tags/kzg-proofs>kzg-proofs</a></code></small>
<small><code><a href=https://belijzajac.dev/tags/bls12-381>bls12-381</a></code></small></p><div class=table-of-contents><h5><b>CONTENTS</b></h5><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#how-c-kzg-4844-does-things>How c-kzg-4844 does things</a></li><li><a href=#how-go-kzg-4844-does-things>How go-kzg-4844 does things</a></li><li><a href=#how-we-do-things-in-rust-kzg>How we do things in rust-kzg</a></li><li><a href=#code-example>Code example</a></li><li><a href=#results>Results</a></li><li><a href=#summary>Summary</a></li></ul></nav></div><p><img src=/post-images/protodanksharding.jpg alt=protodanksharding></p><h2 id=introduction>Introduction</h2><p>The Ethereum Foundation proposed <mark><a href=https://eips.ethereum.org/EIPS/eip-4844>EIP-4844</a></mark> on February 25, 2022, with the objective of reducing gas fees. It introduces a new transaction type called &ldquo;blob&rdquo;, which is temporarily stored and committed using the KZG commitment scheme. In addition, the Ethereum Foundation developed a project called <mark><a href=https://github.com/ethereum/c-kzg-4844>c-kzg-4844</a></mark>, which provides a minimal implementation of the polynomial commitments API written in C. This project does not use parallelization and exposes its C API for bindings in different programming languages. Another project, called <mark><a href=https://github.com/crate-crypto/go-kzg-4844>go-kzg-4844</a></mark>, which uses parallelism, has been practically implemented into the Ethereum code and is rumored to be the fastest implementation of EIP-4844 thus far.</p><p>Next week, I will be defending my thesis titled &ldquo;Parallelization of the KZG10 scheme&rdquo;. In my thesis, I parallelized the KZG commitment scheme and BLS12-381 elliptic curve operations, along with a subset of the EIP-4844 proposal that uses these KZG commitments. My changes were incorporated into the <mark><a href=https://github.com/sifraitech/rust-kzg>rust-kzg project</a></mark>, where we exported C functions through Rust to bind the parallelized functions of rust-kzg backends to those of c-kzg-4844. Fortunately, we were presented with a unique opportunity due to the go binding included in the c-kzg-4844 project. We then used this binding to benchmark our rust-kzg&rsquo;s highly parallelized blst backend against their go-kzg-4844 project and assess its speed in comparison.</p><h2 id=how-c-kzg-4844-does-things>How c-kzg-4844 does things</h2><p>C-kzg-4844 leaves the implementation of parallelism to higher-level programming languages that use its bindings. This approach is not only simpler but also safer. The focus of c-kzg-4844 is on single-core performance, which is great for a low-latency environment.</p><h2 id=how-go-kzg-4844-does-things>How go-kzg-4844 does things</h2><p>Go-kzg-4844 offers the function <code>VerifyBlobKZGProofBatch</code>, which is designed for single-core execution similar to c-kzg-4844. However, they also provide a parallelized version of this function called <code>VerifyBlobKZGProofBatchPar</code>. This parallelized version uses go-routines to process each proof in parallel. Although not perfect, this parallel implementation is considerably faster than the sequential one.</p><h2 id=how-we-do-things-in-rust-kzg>How we do things in rust-kzg</h2><p>The general idea behind our approach is as follows: if the number of blobs exceeds the number of physical CPU cores, we divide the blobs into subgroups of equal size. Each CPU core then independently runs the batched algorithm. For example, consider the illustration below. If there are 64 blobs and 4 CPU cores, we create 4 groups, each containing 16 blobs. Each group is assigned to its dedicated CPU core, which handles the execution of the blob verification process. By utilizing this approach, we effectively distribute the workload across multiple CPU cores, optimizing performance and ensuring efficient verification of the blobs.</p><p><img src=/post-images/batched-blob-verification-approach.png alt=batched-blob-verification-process></p><p>However, one could argue that the performance of batched blob KZG proof verification depends on how Ethereum protocol execution clients choose to utilize this approach. If clients choose to verify blobs as soon as they receive them, they would likely opt for an approach that performs single blob verification faster. However, if they decide to wait and accumulate a fixed amount of blobs before performing the verification, this approach will yield much better performance.</p><h2 id=code-example>Code example</h2><p>In the code snippet, there is more to the implementation, but let&rsquo;s focus on illustrating the main concept of this approach:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#8ec07c>#[cfg(feature = </span><span style=color:#b8bb26>&#34;parallel&#34;</span><span style=color:#8ec07c>)]</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#fe8019>let</span> num_blobs <span style=color:#fe8019>=</span> blobs.len();
</span></span><span style=display:flex><span>    <span style=color:#fe8019>let</span> num_cores <span style=color:#fe8019>=</span> num_cpus::get_physical();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#fe8019>return</span> <span style=color:#fe8019>if</span> num_blobs <span style=color:#fe8019>&gt;</span> num_cores {
</span></span><span style=display:flex><span>        <span style=color:#928374;font-style:italic>// Process blobs in parallel subgroups
</span></span></span><span style=display:flex><span><span style=color:#928374;font-style:italic></span>        <span style=color:#fe8019>let</span> blobs_per_group <span style=color:#fe8019>=</span> num_blobs <span style=color:#fe8019>/</span> num_cores;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        blobs
</span></span><span style=display:flex><span>            .par_chunks(blobs_per_group)
</span></span><span style=display:flex><span>            .enumerate()
</span></span><span style=display:flex><span>            .all(<span style=color:#fe8019>|</span>(i, blob_group)<span style=color:#fe8019>|</span> {
</span></span><span style=display:flex><span>                <span style=color:#fe8019>let</span> num_blobs_in_group <span style=color:#fe8019>=</span> blob_group.len();
</span></span><span style=display:flex><span>                <span style=color:#fe8019>let</span> commitment_group <span style=color:#fe8019>=</span> <span style=color:#fe8019>&amp;</span>commitments_g1
</span></span><span style=display:flex><span>                    [blobs_per_group <span style=color:#fe8019>*</span> i<span style=color:#fe8019>..</span>blobs_per_group <span style=color:#fe8019>*</span> i <span style=color:#fe8019>+</span> num_blobs_in_group];
</span></span><span style=display:flex><span>                <span style=color:#fe8019>let</span> proof_group <span style=color:#fe8019>=</span>
</span></span><span style=display:flex><span>                    <span style=color:#fe8019>&amp;</span>proofs_g1[blobs_per_group <span style=color:#fe8019>*</span> i<span style=color:#fe8019>..</span>blobs_per_group <span style=color:#fe8019>*</span> i <span style=color:#fe8019>+</span> num_blobs_in_group];
</span></span><span style=display:flex><span>                <span style=color:#fe8019>let</span> (evaluation_challenges_fr, ys_fr) <span style=color:#fe8019>=</span>
</span></span><span style=display:flex><span>                    compute_challenges_and_evaluate_polynomial(
</span></span><span style=display:flex><span>                        blob_group,
</span></span><span style=display:flex><span>                        commitment_group,
</span></span><span style=display:flex><span>                        ts,
</span></span><span style=display:flex><span>                    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                verify_kzg_proof_batch(
</span></span><span style=display:flex><span>                    commitment_group,
</span></span><span style=display:flex><span>                    <span style=color:#fe8019>&amp;</span>evaluation_challenges_fr,
</span></span><span style=display:flex><span>                    <span style=color:#fe8019>&amp;</span>ys_fr,
</span></span><span style=display:flex><span>                    proof_group,
</span></span><span style=display:flex><span>                    ts,
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>            })
</span></span><span style=display:flex><span>    } <span style=color:#fe8019>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#928374;font-style:italic>// Each group contains either one or zero blobs, so iterate
</span></span></span><span style=display:flex><span><span style=color:#928374;font-style:italic></span>        <span style=color:#928374;font-style:italic>// over the single blob verification function in parallel
</span></span></span><span style=display:flex><span><span style=color:#928374;font-style:italic></span>        (blobs, commitments_g1, proofs_g1)
</span></span><span style=display:flex><span>            .into_par_iter()
</span></span><span style=display:flex><span>            .all(<span style=color:#fe8019>|</span>(blob, commitment, proof)<span style=color:#fe8019>|</span> {
</span></span><span style=display:flex><span>                verify_blob_kzg_proof(blob, commitment, proof, ts)
</span></span><span style=display:flex><span>            })
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>When <code>num_blobs > num_cores</code>, the code divides the blobs into parallel subgroups. The number of blobs per group is calculated based on the division. The code then iterates over each subgroup, performing various operations such as retrieving the corresponding commitment and proof groups. It also computes evaluation challenges and evaluates a polynomial using the provided data. Finally, it verifies a batch of KZG proofs using the obtained information.</p><p>In the else statement, when the number of blobs is not greater than the number of cores, the code handles each blob individually or in groups with only one blob. It uses parallel iteration to execute the blob verification function concurrently, similar to how go-kzg-4844 handles parallelism using go-routines.</p><h2 id=results>Results</h2><p><img src=/post-images/batched-blob-verification-results.png alt=batched-blob-verification-results></p><p>Rust and Go bindings, using the rust-kzg with blst backend, verified 64 blobs on 16 cores in 29.82 ms and 30.164 ms, respectively. In comparison, the native rust-kzg accomplished this task in 18.397 ms, while the parallelized implementation of go-kzg-4844 took 48.037 ms. It’s important to note that we only perform full error checking through the exported C API when we convert bytes to our internal types. Therefore, the performance of the native rust-kzg code is probably better because we omit those checks here, assuming we receive correct data from the byte conversion functions. With this in mind, the <mark>rust-kzg with blst backend outperformed go-kzg-4844 by approximately 161.11% in terms of speed, while its bindings were approximately 59.25% faster</mark>.</p><h2 id=summary>Summary</h2><ul><li>We potentially outperform go-kzg-4844 by approximately 59.25% within Go in batched blob KZG proof verification</li></ul><div class=separator></div><br><div class=media><div class=media-left><img src=https://belijzajac.dev/author.jpg alt=selfie class="mr-3 mt-3 rounded-circle" style="border:2px solid #d8d8d8;border-radius:50%"></div><div class=media-body><h4 class=media-heading>The author behind this post</h4>Hi there! My online handle is belijzajac, which translates to "white hare" in Russian. I'm a software developer with a strong passion for C++20, Rust, Linux, and compilers. With a solid foundation in these technologies, I'm always looking for new ways to challenge myself and grow as a developer. In my free time, you can find me tinkering with new technologies and keeping up to date with the latest industry trends. Thank you for visiting my blog!</div></div><br><div class=separator></div><br><script src=https://giscus.app/client.js data-repo=belijzajac/belijzajac data-repo-id=R_kgDOJVyeTQ data-category=Announcements data-category-id=DIC_kwDOJVyeTc4CWr12 data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=en data-loading=lazy crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the comments powered by giscus.</noscript><script src=https://belijzajac.dev/js/toc.js></script></article><script type=application/javascript>countDownDate=new Date("2021-12-23");var x=setInterval(function(){var n=(new Date).getTime(),e=n-countDownDate.getTime(),t=Math.floor(e/(365*1e3*60*60*24)),s=Math.floor(e/(1e3*60*60*24)-(t>0?365*t:0)),o=Math.floor(e%(1e3*60*60*24)/(1e3*60*60)),i=Math.floor(e%(1e3*60*60)/(1e3*60)),a=Math.floor(e%(1e3*60)/1e3);document.getElementById("demo").innerHTML=(t>0?t+"y ":"")+s+"d "+o+"h "+i+"m "+a+"s "},1e3)</script><footer class=footer><span>Website is running for <tag id=demo></tag><br>Copyright © 2023
<a href=https://github.com/belijzajac target=_blank rel=noopener>belijzajac</a>
| <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel=noopener>CC BY-NC-SA 4.0</a></span></footer></div><script src=https://belijzajac.dev/js/jquery-3.3.1.slim.min.js></script>
<script src=https://belijzajac.dev/js/bootstrap.bundle.min.js></script>
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-217331412-1","auto"),ga("send","pageview")</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>